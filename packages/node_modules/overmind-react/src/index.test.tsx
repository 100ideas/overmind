import { Overmind, TAction, TApp } from 'overmind'
import * as React from 'react'
import * as renderer from 'react-test-renderer'

import { TConnect, createConnect } from './'

describe('React', () => {
  test('should connect state and actions to stateless components', () => {
    expect.assertions(2)
    let didCallAction = false
    const doThis: Action = () => (didCallAction = true)

    const config = {
      state: {
        foo: 'bar',
      },
      actions: {
        doThis,
      },
    }

    type IApp = TApp<{
      state: {
        foo: typeof config.state.foo
      }
      actions: {
        doThis: typeof doThis
      }
    }>

    const app = new Overmind(config)

    type Action<Input = void, Output = any> = TAction<IApp, Input, Output>

    const connect = createConnect(app)

    const Component: React.SFC<TConnect<typeof app>> = ({ app }) => {
      app.actions.doThis()
      return <h1>{app.state.foo}</h1>
    }
    const ConnectedComponent = connect(Component)
    const tree = renderer.create(<ConnectedComponent />).toJSON()

    expect(didCallAction).toBe(true)
    expect(tree).toMatchSnapshot()
  })

  test('should connect actions and state to class components', () => {
    expect.assertions(2)
    let didCallAction = false
    const doThis: Action = () => (didCallAction = true)
    const config = {
      state: {
        foo: 'bar',
      },
      actions: {
        doThis,
      },
    }

    type IApp = TApp<{
      state: {
        foo: typeof config.state.foo
      }
      actions: {
        doThis: typeof doThis
      }
    }>

    const app = new Overmind(config)

    type Action<Input = void, Output = any> = TAction<IApp, Input, Output>

    const connect = createConnect(app)

    class Component extends React.Component<TConnect<typeof app>> {
      componentDidMount() {
        app.actions.doThis()
      }
      render() {
        const { app } = this.props

        return <h1>{app.state.foo}</h1>
      }
    }
    const ConnectedComponent = connect(Component)
    const tree = renderer.create(<ConnectedComponent />).toJSON()

    expect(didCallAction).toBe(true)
    expect(tree).toMatchSnapshot()
  })

  test('should allow using component as normal, event when connected', () => {
    expect.assertions(2)
    const config = {
      state: {
        foo: 'bar',
      },
    }

    const app = new Overmind(config)

    const connect = createConnect(app)

    class Component extends React.Component<TConnect<typeof app>> {
      render() {
        const { app } = this.props

        return <h1>{app ? app.state.foo : 'nada'}</h1>
      }
    }
    const ConnectedComponent = connect(Component)
    const tree = renderer.create(<ConnectedComponent />).toJSON()
    const tree2 = renderer.create(<Component app={null} />).toJSON()

    expect(tree).toMatchSnapshot()
    expect(tree2).toMatchSnapshot()
  })

  test('should connect reactions to components', () => {
    expect.assertions(2)
    let reactionCount = 0
    const doThis: Action = ({ state }) => (state.foo = 'bar2')

    const config = {
      state: {
        foo: 'bar',
      },
      actions: {
        doThis,
      },
    }
    type IApp = TApp<{
      state: {
        foo: typeof config.state.foo
      }
      actions: {
        doThis: typeof doThis
      }
    }>

    const app = new Overmind(config)

    type Action<Input = void, Output = any> = TAction<IApp, Input, Output>

    const connect = createConnect(app)

    class Component extends React.Component<TConnect<typeof app>> {
      componentDidMount() {
        this.props.app.reaction(
          'my-reaction',
          (state) => state.foo,
          () => {
            reactionCount++
          }
        )
      }
      render() {
        const { app } = this.props
        return <h1>{app.state.foo}</h1>
      }
    }
    const ConnectedComponent = connect(Component)
    const instance = renderer.create(<ConnectedComponent />)
    app.actions.doThis()
    expect(reactionCount).toBe(1)
    instance.unmount()
    app.actions.doThis()
    expect(reactionCount).toBe(1)
  })

  test('should preserve component name', () => {
    const app = new Overmind({})
    const connect = createConnect(app)

    class FooComponent extends React.Component<TConnect<typeof app>> {
      render() {
        return <h1>hop</h1>
      }
    }
    function BarComponent() {
      return <div />
    }

    const ConnectedFoo = connect(FooComponent)
    const ConnectedBar = connect(BarComponent)
    expect(ConnectedFoo.name).toBe('FooComponent')
    expect(ConnectedBar.name).toBe('BarComponent')
  })
})
