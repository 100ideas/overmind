import { pipe, map, forEach, filter, fork, when, Pipe } from './'

function createMockAction(pipe) {
  return (value) =>
    new Promise((resolve, reject) => {
      const context = {
        state: {},
        value,
        execution: {
          actionId: 0,
          executionId: 0,
          operatorId: 0,
          path: [],
          startMutationTracking: () => {},
          clearMutationTracking: () => {},
          emit: () => {},
        },
      }
      pipe(
        null,
        context,
        (err, { value }) => {
          if (err) reject(err)
          else resolve(value)
        }
      )
    }).catch(console.error)
}

describe('PIPE', () => {
  test('should create and run pipes', () => {
    expect.assertions(1)
    const test = pipe((_, value, next) => {
      next(null, value)
    })

    return createMockAction(test)('foo').then((value) => {
      expect(value).toBe('foo')
    })
  })
  describe('OPERATORS', () => {
    test('map', () => {
      expect.assertions(1)
      const test: Pipe<string> = pipe(map(({ value }) => value.toUpperCase()))

      return createMockAction(test)('foo').then((value) => {
        expect(value).toBe('FOO')
      })
    })
    test('map (async)', () => {
      expect.assertions(1)
      const test = pipe<string>(
        map(({ value }) => Promise.resolve(value.toUpperCase()))
      )

      return createMockAction(test)('foo').then((value) => {
        expect(value).toBe('FOO')
      })
    })
    test('forEach', () => {
      expect.assertions(1)
      let runCount = 0
      const test = pipe<string[]>(
        forEach(
          ({ value }) => value,
          (_, val, next) => {
            runCount++
            next(null, val)
          }
        )
      )

      return createMockAction(test)(['foo']).then(() => {
        expect(runCount).toEqual(1)
      })
    })
    test('filter - truthy', () => {
      expect.assertions(1)
      const test = pipe<string>(
        filter(({ value }) => value === 'foo'),
        map(({ value }) => value.toUpperCase())
      )

      return createMockAction(test)('foo').then((value) => {
        expect(value).toBe('FOO')
      })
    })
    test('filter - falsy', () => {
      const test = pipe<string>(
        filter(({ value }) => value === 'bar'),
        map(({ value }) => value.toUpperCase())
      )

      return createMockAction(test)('foo').then((value) => {
        expect(value).toBe('foo')
      })
    })
    test('fork', () => {
      expect.assertions(1)
      const test = pipe<string>(
        fork(() => 'foo', {
          foo: map(({ value }) => value.toUpperCase()),
        })
      )

      return createMockAction(test)('foo').then((value) => {
        expect(value).toBe('FOO')
      })
    })
    test('when', () => {
      expect.assertions(1)
      const test = pipe<string>(
        when(() => true, {
          true: map(({ value }) => value.toUpperCase()),
          false: map(({ value }) => value),
        })
      )

      return createMockAction(test)('foo').then((value) => {
        expect(value).toBe('FOO')
      })
    })
  })
})
