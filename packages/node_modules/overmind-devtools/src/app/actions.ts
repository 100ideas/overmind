import { Action } from '../app'
import * as mutations from './mutations'
import * as operations from './operations'
import { Message, Tab } from './state'

const onMessage: Action<Message> = (action) =>
  action()
    .mutation(mutations.performMutationsByMessageType)
    .mutation(mutations.addMessagesFromClient)

export const loadDevtools: Action = (action) =>
  action()
    // .do(({ storage }) => storage.clear())
    // Do a check if the current app matches the keys of the ???
    .map(operations.getAppsFromStorage)
    .mutation(mutations.setApps)
    .map(operations.getCurrentPortFromStorage)
    .mutation(mutations.setCurrentPort)
    .mutation(mutations.setAppLoaded)
    .do(operations.connectCurrentPort(onMessage(action)))

export const setError: Action<string> = (action) =>
  action().mutation(mutations.setError)

export const changeNewPortValue: Action<string> = (action) =>
  action()
    .map(operations.toNumber)
    .mutation(mutations.setNewPortValue)

export const addPort: Action = (action) =>
  action()
    .map(operations.getNewPortFromState)
    .mutation(mutations.setCurrentPort)
    .mutation(mutations.addNewApp)
    .mutation(mutations.resetNewPortValue)
    .do(operations.storeApps)
    .do(operations.connectCurrentPort(onMessage))

export const changeTab: Action<Tab> = (action) =>
  action().mutation(mutations.changeTab)

export const toggleExpandState: Action<string[]> = (action) =>
  action().mutation(mutations.toggleExpandStatePath)

export const selectAction: Action<string> = (action) =>
  action()
    .mutation(mutations.toggleActionItemCollapse)
    .mutation(mutations.selectAction)

type Collapsed = {
  isCollapsed: boolean
}

export const toggleCollapsed: Action<Collapsed> = (action) =>
  action().mutation(mutations.toggleCollapsed)

export const configurePort: Action = (action) =>
  action().mutation(mutations.configurePort)

export const cancelConfigurePort: Action = (action) =>
  action().mutation(mutations.cancelConfigurePort)

export const removeApp: Action = (action) =>
  action()
    .filter(operations.confirm('Are you sure you want to remove the app?'))
    .do(operations.removeCurrentPort)
    .mutation(mutations.removeApp)
    .do(operations.storeApps)
    .do(operations.connectCurrentPort(onMessage(action)))

export const selectPort: Action<string> = (action) =>
  action()
    .mutation(mutations.selectPort)
    .do(operations.connectCurrentPort(onMessage(action)))
