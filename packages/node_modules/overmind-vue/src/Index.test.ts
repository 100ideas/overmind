import { JSDOM } from 'jsdom'
import { Overmind } from 'overmind'

import { createConnect } from './'
const Vue = require('vue/dist/vue')

const dom = new JSDOM()

describe('Vue', () => {
  it('should mount with connected app', () => {
    const app = new Overmind({
      state: {
        foo: 'bar',
      },
    })
    const connect = createConnect(app)
    const vm = new Vue(
      connect({
        el: dom.window.document.createElement('div'),
      })
    )
    expect(vm.app.state.foo).toBe('bar')
  })
  it('should expose actions', (done) => {
    const app = new Overmind({
      state: {
        foo: 'bar',
      },
      actions: {
        changeFoo: (action) =>
          action.mutate(({ state }) => (state.foo = 'bar2')),
      },
    })
    const connect = createConnect(app)
    const instance = new Vue(
      connect({
        el: dom.window.document.createElement('div'),
      })
    )
    expect(instance.app.state.foo).toBe('bar')
    Vue.nextTick(() => {
      instance.app.actions.changeFoo()
      expect(instance.app.state.foo).toBe('bar2')
      done()
    })
  })
  it('should expose reaction', (done) => {
    expect.assertions(1)
    let hasReacted = false
    const app = new Overmind({
      state: {
        foo: 'bar',
      },
      actions: {
        changeFoo: (action) =>
          action.mutate(({ state }) => (state.foo = 'bar2')),
      },
    })
    const connect = createConnect(app)
    const instance = new Vue(
      connect({
        el: dom.window.document.createElement('div'),
        mounted() {
          this.app.reaction(
            (state) => state.foo,
            () => {
              hasReacted = true
            }
          )
        },
      })
    )
    Vue.nextTick(() => {
      instance.app.actions.changeFoo()
      expect(hasReacted).toBe(true)
      done()
    })
  })
})
